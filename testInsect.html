<!DOCTYPE html>
<html>
  <head>
    <title>昆虫识别测试</title>
    <meta charset="UTF-8">
    <style>
      img {
        max-height: 50vh; /* 设置图片最大高度为视口高度的一半 */
        width: auto; /* 根据高度自动等比缩放图片 */
      }
      #response {
        margin-top: 20px;
        white-space: pre-line; /* 设置pre标签中的换行为可显示的文本换行符 */
      }
      .overlay {
        display: flex;
        position: fixed;
        top: 0;
        left: 0;
        bottom: 0;
        right: 0;
        background-color: rgba(255, 255, 255, 0.5);
        align-items: center;
        justify-content: center;
      }
      .loading {
        display: inline-block;
        border: 6px solid #f3f3f3;
        border-top: 6px solid #3498db;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 2s linear infinite;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
  </head>
  <body>
    <h1 style="font-size:48px">上传昆虫图片</h1>
    <h2>图片中请只有一只昆虫，并且近距拍摄，图片底色最好为纯色</h2>
    <form enctype="multipart/form-data" method="post" id="myForm">
      <label for="file"></label>
      <input style="font-size:36px" type="file" id="file" name="file" accept=".jpg,.jpeg,.png,.bmp" required>
    </form>

    <div class="overlay" id="loading" style="display:none;"><div class="loading"></div></div>
    <img id="preview" src="#" alt="选择一张图片" style="display:none;">
    <pre id="response" style="display:none;"></pre>
    
    <script>
      var xmlhttp;
      var preview;
      function createXHR() {
        if (window.XMLHttpRequest) {
          xmlhttp = new XMLHttpRequest();
        } else {
          xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
        }
      }

      function previewImage(input) {
        preview = document.getElementById('preview');
        if (input.files && input.files[0]) {
          var reader = new FileReader();
          reader.readAsDataURL(input.files[0]);

          reader.onload = function (e) {
            var img = new Image();
            img.src = e.target.result;

            img.onload = function() {

              var width = img.width;
              var height = img.height;
              var size = parseInt(e.total / 1024);
              if (size > 4096) {
                alert("上传图片的大小不能超过4M！");
                return false;
              } else if (width < 15 || height < 15) {
                alert("上传图片最短边长度不能小于15px！");
                return false;
              } else if (Math.max(width, height) > 4096) {
                alert("上传图片最长边长度不能超过4096px！");
                return false;
              } else {

                preview.src = img.src;
                preview.style.display = 'block';
                sendImage(img.src);
                return true;
              }
            }
          };
        }
      }
      document.querySelector('input[type="file"]').addEventListener('change', function() {

        previewImage(this);
      });

      var timer;
      function timeoutHandler() {
        xmlhttp.abort();
        showLoading(false);
        alert("请求超时，请稍后重试！");
      }

      var loading = document.getElementById('loading');
      function showLoading(show) {
        clearTimeout(timer);
        if (show) {
          loading.style.display = 'flex';
          timer = setTimeout(timeoutHandler, 5000);
        } else {
          loading.style.display = 'none';
        }
      }

      function sendImage(base64Data) {
        var url = "https://aip.baidubce.com/rest/2.0/image-classify/v1/animal?access_token=24.e98ed64e0161932d9e7a8a49eed49f5d.2592000.1684135331.282335-32419812";
        createXHR();
        xmlhttp.open("POST", url, true);
        xmlhttp.onreadystatechange = function() {

          if (xmlhttp.readyState === 4 && xmlhttp.status === 200) {
            showLoading(false);

            var responseJSON = JSON.parse(xmlhttp.responseText);
            var responseEl = document.getElementById("response");
            let _tmpObj = responseJSON.result;

            let _noBugIdx = 100000;
            Object.keys(_tmpObj).forEach((key) => {
              var _tmpSubObj = _tmpObj[key].baike_info;
              Object.keys(_tmpSubObj).forEach((key01) => {
                if (key01 == "baike_url" || key01 == "image_url"){
                  delete _tmpSubObj[key01];
                }

                if (key01 == "description"){
                  if ((_tmpSubObj[key01].indexOf("食虫") > -1  || _tmpSubObj[key01].indexOf("哺乳") > -1 || _tmpSubObj[key01].indexOf("爬行") > -1 || _tmpSubObj[key01].indexOf("鱼") > -1 || _tmpSubObj[key01].indexOf("啮齿") > -1) &&
                      (_tmpSubObj[key01].indexOf("虫") == -1 || _tmpSubObj[key01].indexOf("蜂") == -1 || _tmpSubObj[key01].indexOf("蛛") == -1)){
                    _noBugIdx = key;
                    _tmpObj[key].name = "非昆虫"
                    _tmpSubObj[key01] = "无";
                  }
                }
              });
            });

            Object.keys(_tmpObj).forEach((key) => {
              if (JSON.stringify(_tmpObj[key].baike_info) === '{}') {
                _tmpObj[key].baike_info = {description: '无'};          
              }
            });

            Object.keys(_tmpObj).forEach((key) => {      
              if (_noBugIdx > 0 && key >= _noBugIdx){
                delete _tmpObj[key];
              }
            });

            let _tmpJsonStr = JSON.stringify(_tmpObj, null, 2);
   
            _tmpJsonStr = _tmpJsonStr.replaceAll(',', '');
            _tmpJsonStr = _tmpJsonStr.replaceAll('[', '').replaceAll(']', '');
            _tmpJsonStr = _tmpJsonStr.replaceAll('{', '——————');
            _tmpJsonStr = _tmpJsonStr.replaceAll('}', '');
            _tmpJsonStr = _tmpJsonStr.replaceAll('\"', '');
            _tmpJsonStr = _tmpJsonStr.replaceAll("name", '名称');
            _tmpJsonStr = _tmpJsonStr.replaceAll("score", '概率');

            _tmpJsonStr = _tmpJsonStr.replaceAll("baike_info: ——————", '');
            _tmpJsonStr = _tmpJsonStr.replaceAll("description", '简介');
            
            _tmpJsonStr = _tmpJsonStr.replace(/(\n[\s\t]*\r*\n)/g, '\n').replace(/^[\n\r\n\t]*|[\n\r\n\t]*$/g, '');

            responseEl.innerText = _tmpJsonStr;
            responseEl.style.display = 'block';
            responseEl.style.fontSize = "36px";
          }

        };
        xmlhttp.timeout = 5000; // 设置超时时间为5秒
        xmlhttp.ontimeout = timeoutHandler;
        var _noHeadimgs = base64Data.replace(/^data:image\/\w+;base64,/, "");
        var formData = new FormData();
        formData.append("image", _noHeadimgs);
        formData.append("top_num", 3);
        formData.append("baike_num", 3);
        xmlhttp.send(formData);
        showLoading(true);
      }
    </script>
  </body>
</html>